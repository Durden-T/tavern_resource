{"version":3,"file":"index.js","mappings":"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","sources":["src://tavern_helper_template/external var \"Vue\"","src://tavern_helper_template/external var \"z\"","src://tavern_helper_template/src/酒馆助手/压缩相邻消息/settings.ts","src://tavern_helper_template/util/common.ts","src://tavern_helper_template/src/酒馆助手/压缩相邻消息/squash.ts","src://tavern_helper_template/src/酒馆助手/深度条目排斥器/index.ts","src://tavern_helper_template/util/script.ts"],"sourcesContent":["const __WEBPACK_NAMESPACE_OBJECT__ = Vue;","const __WEBPACK_NAMESPACE_OBJECT__ = z;","import { defineStore } from 'pinia';\nimport { ref, watchEffect } from 'vue';\nexport const Settings = z\n    .object({\n    name: z.string().default('压缩相邻消息'),\n    seperator: z\n        .object({\n        type: z.enum(['space', 'newline', 'double newline', 'custom']).default('double newline'),\n        value: z.string().default('\\n\\n'),\n    })\n        .prefault({})\n        .transform(data => {\n        switch (data.type) {\n            case 'space':\n                data.value = ' ';\n                break;\n            case 'newline':\n                data.value = '\\n';\n                break;\n            case 'double newline':\n                data.value = '\\n\\n';\n                break;\n            case 'custom':\n                break;\n        }\n        return data;\n    }),\n    depth_threshold: z.number().int().min(1).default(10),\n    move_system_to_front: z.boolean().default(false),\n    move_system_to_back: z.boolean().default(false),\n    convert_system_to_user: z.boolean().default(false),\n    above_placeholder: z.string().default(''),\n    below_placeholder: z.string().default(''),\n    put_system_injection_after_chat_history: z.boolean().optional(),\n    on_chat_history: z\n        .object({\n        type: z.enum(['mixin', 'seperate', 'squash']).default('squash'),\n        squash_role: z.enum(['user', 'assistant', 'system']).default('assistant'),\n        user_prefix: z.string().default('[{{user}}]\\n'),\n        user_suffix: z.string().default('\\n[/{{user}}]'),\n        assistant_prefix: z.string().default('[剧情]\\n'),\n        assistant_suffix: z.string().default('\\n[/剧情]'),\n        system_prefix: z.string().default('[设定]\\n'),\n        system_suffix: z.string().default('\\n[/设定]'),\n    })\n        .prefault({}),\n    stop_string: z.string().default('<|im_end|>').catch('<|im_end|>'),\n})\n    .transform(data => {\n    if (data.put_system_injection_after_chat_history === true) {\n        data.move_system_to_front = true;\n        data.move_system_to_back = true;\n    }\n    delete data.put_system_injection_after_chat_history;\n    return data;\n});\nexport const useSettingsStore = defineStore('settings', () => {\n    const settings = ref(Settings.parse(getVariables({ type: 'script', script_id: getScriptId() })));\n    watchEffect(() => {\n        insertOrAssignVariables(klona(settings.value), { type: 'script', script_id: getScriptId() });\n    });\n    return { settings };\n});\n","import { compare } from 'compare-versions';\nimport { toDotPath } from 'zod/v4/core';\n\nexport function assignInplace<T>(destination: T[], new_array: T[]): T[] {\n  destination.length = 0;\n  destination.push(...new_array);\n  return destination;\n}\n\nexport function chunkBy<T>(array: T[], predicate: (lhs: T, rhs: T) => boolean): T[][] {\n  if (array.length === 0) {\n    return [];\n  }\n\n  const chunks: T[][] = [[array[0]]];\n  for (const [lhs, rhs] of _.zip(_.dropRight(array), _.drop(array))) {\n    if (predicate(lhs!, rhs!)) {\n      chunks[chunks.length - 1].push(rhs!);\n    } else {\n      chunks.push([rhs!]);\n    }\n  }\n  return chunks;\n}\n\nexport function regexFromString(input: string): RegExp | null {\n  if (!input) {\n    return null;\n  }\n  try {\n    const match = input.match(/\\/(.+)\\/([a-z]*)/i);\n    if (!match) {\n      return new RegExp(_.escapeRegExp(input), 'i');\n    }\n    if (match[2] && !/^(?!.*?(.).*?\\1)[gmixXsuUAJ]+$/.test(match[3])) {\n      return new RegExp(input, 'i');\n    }\n    let flags = match[2] ?? '';\n    _.pull(flags, 'g');\n    if (flags.indexOf('i') === -1) {\n      flags = flags + 'i';\n    }\n    return new RegExp(match[1], flags);\n  } catch {\n    return null;\n  }\n}\n\nexport function uuidv4(): string {\n  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {\n    const r = (Math.random() * 16) | 0;\n    const v = c === 'x' ? r : (r & 0x3) | 0x8;\n    return v.toString(16);\n  });\n}\n\nexport async function checkMinimumVersion(expected: string, title: string) {\n  if (compare(await getTavernHelperVersion(), expected, '<')) {\n    toastr.error(`'${title}' 需要酒馆助手版本 >= '${expected}'`, '版本不兼容');\n  }\n}\n\nexport function prettifyErrorWithInput(error: z.ZodError) {\n  return _([...error.issues])\n    .sortBy(issue => issue.path?.length ?? 0)\n    .flatMap(issue => {\n      const lines = [`✖ ${issue.message}`];\n      if (issue.path?.length) {\n        lines.push(`  → 路径: ${toDotPath(issue.path)}`);\n      }\n      if (issue.input !== undefined) {\n        lines.push(`  → 输入: ${JSON.stringify(issue.input)}`);\n      }\n      return lines;\n    })\n    .join('\\n');\n}\n","import { assignInplace, chunkBy, regexFromString, uuidv4 } from '@util/common';\nimport { compare } from 'compare-versions';\nimport { Settings } from './settings';\n\ntype Prompt = {\n  role: 'user' | 'assistant' | 'system';\n  content: string;\n};\n\n//----------------------------------------------------------------------------------------------------------------------\ntype Seperators = {\n  head: InjectionPrompt;\n  deep: InjectionPrompt;\n  tail: InjectionPrompt;\n};\n\nfunction injectSeperators(settings: Settings) {\n  const seperators = Object.freeze({\n    head: {\n      id: `\\0${settings.name}`,\n      position: 'in_chat',\n      depth: 9999,\n      role: 'assistant',\n      content: uuidv4(),\n    },\n    deep: {\n      id: `\\xff${settings.name}深度分割`,\n      position: 'in_chat',\n      // 减1以兼容之前的行为：分隔符位于D阈值下方，确保同深度的系统条目排在分隔符之前\n      depth: settings.depth_threshold - 1,\n      role: 'system',\n      content: uuidv4(),\n    },\n    tail: {\n      id: `\\xff${settings.name}\\xff`,\n      position: 'in_chat',\n      depth: 0,\n      role: 'system',\n      content: uuidv4(),\n    },\n  } as const);\n\n  const inject = (_type: string, _option: object, dry_run: boolean) => {\n    if (dry_run) {\n      return;\n    }\n    injectPrompts(Object.values(seperators));\n  };\n  eventOn(tavern_events.GENERATION_AFTER_COMMANDS, inject);\n\n  return {\n    seperators,\n    uninject: () => {\n      eventRemoveListener(tavern_events.GENERATION_AFTER_COMMANDS, inject);\n      uninjectPrompts(Object.values(seperators).map(({ id }) => id));\n    },\n  };\n}\n\n//----------------------------------------------------------------------------------------------------------------------\nfunction seperatePrompts(prompts: Prompt[], seperators: Seperators): Prompt[][] | null {\n  const head_index = prompts.findIndex(({ content }) => content.includes(seperators.head.content));\n  const deep_index = prompts.findIndex(({ content }) => content.includes(seperators.deep.content));\n  const tail_index = prompts.findIndex(({ content }) => content.includes(seperators.tail.content));\n  if (head_index === -1 || deep_index === -1 || tail_index === -1) {\n    return null;\n  }\n  if (!(head_index < deep_index && deep_index < tail_index)) {\n    return null;\n  }\n\n  const stripSeperatorIds = (str: string): string =>\n    str\n      .replaceAll(seperators.head.id, '')\n      .replaceAll(seperators.deep.id, '')\n      .replaceAll(seperators.tail.id, '');\n\n  const split_with_context = (\n    splitted_before: [string, string],\n    before_index: number,\n    current_index: number,\n    splitter: string,\n  ): [string, string] => {\n    if (before_index !== current_index) {\n      return prompts[current_index].content.split(splitter) as [string, string];\n    }\n    const splitted = splitted_before[1].split(splitter) as [string, string];\n    splitted_before[1] = '';\n    return splitted;\n  };\n\n  const splitted_head = split_with_context(['', ''], -1, head_index, seperators.head.content);\n  const splitted_deep = split_with_context(splitted_head, head_index, deep_index, seperators.deep.content);\n  const splitted_tail = split_with_context(splitted_deep, deep_index, tail_index, seperators.tail.content);\n\n  return [\n    [...prompts.slice(0, head_index), { role: prompts[head_index].role, content: stripSeperatorIds(splitted_head[0]) }],\n    [\n      { role: prompts[head_index].role, content: stripSeperatorIds(splitted_head[1]) },\n      ...prompts.slice(head_index + 1, deep_index),\n      { role: prompts[deep_index].role, content: stripSeperatorIds(splitted_deep[0]) },\n    ],\n    [\n      { role: prompts[deep_index].role, content: stripSeperatorIds(splitted_deep[1]) },\n      ...prompts.slice(deep_index + 1, tail_index),\n      { role: prompts[tail_index].role, content: stripSeperatorIds(splitted_tail[0]) },\n    ],\n    [{ role: prompts[tail_index].role, content: stripSeperatorIds(splitted_tail[1]) }, ...prompts.slice(tail_index + 1)],\n  ];\n}\n\nfunction convertSystemToUserAfterFirstNonSystem(prompts: Prompt[]): void {\n  const firstNonSystemIndex = prompts.findIndex(p => p.role === 'user' || p.role === 'assistant');\n  if (firstNonSystemIndex === -1) {\n    return;\n  }\n  for (let i = firstNonSystemIndex + 1; i < prompts.length; i++) {\n    if (prompts[i].role === 'system') {\n      prompts[i].role = 'user';\n    }\n  }\n}\n\nfunction trimEmptyLines(str: string): string {\n  const lines = str.split('\\n');\n  let start = 0;\n  let end = lines.length;\n  while (start < end && !lines[start].trim()) start++;\n  while (end > start && !lines[end - 1].trim()) end--;\n  return lines.slice(start, end).join('\\n');\n}\n\nfunction rejectEmptyPrompts(prompts: Prompt[]): Prompt[] {\n  return prompts.filter(({ content }) => content.trim() !== '');\n}\n\nfunction squashMessageByRole(prompts: Prompt[], settings: Settings): Prompt[] {\n  return chunkBy(prompts, (lhs, rhs) => lhs.role === rhs.role).map(chunk => ({\n    role: chunk[0].role,\n    content: chunk.map(({ content }) => trimEmptyLines(content)).join(settings.seperator.value),\n  }));\n}\n\nfunction squashChatHistory(prompts: Prompt[], settings: Settings): Prompt {\n  // TODO: zod encode\n  const system_prefix = substitudeMacros(settings.on_chat_history.system_prefix);\n  const system_suffix = substitudeMacros(settings.on_chat_history.system_suffix);\n  const assistant_prefix = substitudeMacros(settings.on_chat_history.assistant_prefix);\n  const assistant_suffix = substitudeMacros(settings.on_chat_history.assistant_suffix);\n  const user_prefix = substitudeMacros(settings.on_chat_history.user_prefix);\n  const user_suffix = substitudeMacros(settings.on_chat_history.user_suffix);\n  return {\n    role: settings.on_chat_history.squash_role,\n    content: prompts\n      .map(({ role, content }) => {\n        const trimmed = trimEmptyLines(content);\n        switch (role) {\n          case 'system':\n            return system_prefix + trimmed + system_suffix;\n          case 'assistant':\n            return assistant_prefix + trimmed + assistant_suffix;\n          case 'user':\n            return user_prefix + trimmed + user_suffix;\n        }\n      })\n      .join(settings.seperator.value),\n  };\n}\n\nfunction listenEvent(settings: Settings, seperators: Seperators) {\n  const handlePrompts = ({ prompt }: { prompt: SillyTavern.SendingMessage[] }, dry_run: boolean) => {\n    if (dry_run) {\n      return;\n    }\n\n    if (prompt.some(({ content }) => typeof content !== 'string')) {\n      // TODO: 支持带图片、多媒体的脚本\n      return;\n    }\n\n    // @ts-expect-error 类型正确\n    const chunks = seperatePrompts(prompt, seperators);\n    if (chunks === null) {\n      return;\n    }\n\n    const { above_placeholder, below_placeholder, move_system_to_front, move_system_to_back, seperator } = settings;\n    const allPrompts = chunks.flat();\n\n    // 含占位符的系统消息需保留原位，占位符会被替换为提取的内容\n    const isSystemWithoutPlaceholder = (p: Prompt): boolean =>\n      p.role === 'system' &&\n      !(above_placeholder && p.content.includes(above_placeholder)) &&\n      !(below_placeholder && p.content.includes(below_placeholder));\n\n    const extractSystemContent = (chunk: Prompt[]): string =>\n      chunk.filter(isSystemWithoutPlaceholder).filter(p => p.content.trim()).map(p => trimEmptyLines(p.content)).join(seperator.value);\n\n    // 先提取内容，再移除/移动消息\n    const aboveContent = move_system_to_front ? extractSystemContent(chunks[1]) : '';\n    const belowContent = move_system_to_back ? extractSystemContent(chunks[2]) : '';\n\n    if (move_system_to_front) {\n      if (above_placeholder && allPrompts.some(p => p.content.includes(above_placeholder))) {\n        // 有占位符：仅移除，内容通过占位符替换注入\n        _.remove(chunks[1], isSystemWithoutPlaceholder);\n      } else {\n        // 无占位符：直接移动到 head 末尾\n        chunks[0] = _.concat(chunks[0], _.remove(chunks[1], p => p.role === 'system'));\n      }\n    }\n\n    if (move_system_to_back) {\n      if (below_placeholder && allPrompts.some(p => p.content.includes(below_placeholder))) {\n        _.remove(chunks[2], isSystemWithoutPlaceholder);\n      } else {\n        // 无占位符：直接移动到 tail 开头\n        chunks[3] = _.concat(_.remove(chunks[2], p => p.role === 'system'), chunks[3]);\n      }\n    }\n\n    if (settings.convert_system_to_user) {\n      chunks.forEach(chunk => convertSystemToUserAfterFirstNonSystem(chunk));\n    }\n\n    const [head, before_chat_history, after_chat_history, tail] = _(chunks)\n      .map(prompts => rejectEmptyPrompts(prompts))\n      .map(prompts => squashMessageByRole(prompts, settings))\n      .value();\n\n    let result: Prompt[];\n    switch (settings.on_chat_history.type) {\n      case 'mixin':\n        result = squashMessageByRole(_.concat(head, before_chat_history, after_chat_history, tail), settings);\n        break;\n      case 'seperate':\n        result = _.concat(head, squashMessageByRole(_.concat(before_chat_history, after_chat_history), settings), tail);\n        break;\n      case 'squash':\n        result = _.concat(head, squashChatHistory(_.concat(before_chat_history, after_chat_history), settings), tail);\n        break;\n    }\n\n    for (const p of result) {\n      if (above_placeholder) p.content = p.content.replaceAll(above_placeholder, aboveContent);\n      if (below_placeholder) p.content = p.content.replaceAll(below_placeholder, belowContent);\n    }\n\n    assignInplace(prompt, result);\n  };\n  const handlePrompts2 = ({ messages }: { messages: SillyTavern.SendingMessage[] }) => {\n    handlePrompts({ prompt: messages }, false);\n  };\n\n  if (compare(getTavernVersion(), '1.13.4', '>')) {\n    eventMakeFirst(tavern_events.GENERATE_AFTER_DATA, handlePrompts);\n  } else {\n    eventMakeFirst(tavern_events.CHAT_COMPLETION_SETTINGS_READY, handlePrompts2);\n  }\n\n  const handleStopStringOnStream = (text: string) => {\n    if (!settings.stop_string) {\n      return;\n    }\n    const regex = regexFromString(settings.stop_string);\n    if (!regex) {\n      return;\n    }\n    if (regex.test(text)) {\n      SillyTavern.stopGeneration();\n    }\n  };\n  eventMakeFirst(tavern_events.STREAM_TOKEN_RECEIVED, handleStopStringOnStream);\n\n  const handleStopStringOnReceived = async (message_id: number | string) => {\n    if (!settings.stop_string) {\n      return;\n    }\n\n    const chat_message = SillyTavern.chat[Number(message_id)];\n\n    const regex = regexFromString(settings.stop_string);\n    if (!regex) {\n      return;\n    }\n    const match = chat_message.mes.match(regex);\n    if (match) {\n      chat_message.mes = chat_message.mes.slice(0, match.index);\n      if (chat_message.swipes) {\n        _.set(chat_message, ['swipes', chat_message.swipe_id!], chat_message.mes);\n      }\n      // 与 https://gitgud.io/Monblant/noass 采用相同逻辑而不使用 setChatMessages, 因为 CHARACTER_MESSAGE_RENDERED 将会随后自然触发\n      SillyTavern.updateMessageBlock(Number(message_id), chat_message);\n      await SillyTavern.saveChat();\n    }\n  };\n  eventMakeFirst(tavern_events.MESSAGE_RECEIVED, handleStopStringOnReceived);\n\n  return {\n    unlisten: () => {\n      eventRemoveListener(tavern_events.GENERATE_AFTER_DATA, handlePrompts);\n      eventRemoveListener(tavern_events.CHAT_COMPLETION_SETTINGS_READY, handlePrompts2);\n      eventRemoveListener(tavern_events.STREAM_TOKEN_RECEIVED, handleStopStringOnStream);\n      eventRemoveListener(tavern_events.MESSAGE_RECEIVED, handleStopStringOnReceived);\n    },\n  };\n}\n\n//----------------------------------------------------------------------------------------------------------------------\nexport function initSquash(settings: Settings) {\n  const { seperators, uninject } = injectSeperators(settings);\n  const { unlisten } = listenEvent(settings, seperators);\n  return {\n    destroy: () => {\n      uninject();\n      unlisten();\n    },\n  };\n}\n","import { Settings } from '@/酒馆助手/压缩相邻消息/settings';\nimport { initSquash } from '@/酒馆助手/压缩相邻消息/squash';\nimport { checkMinimumVersion } from '@util/common';\nimport { loadReadme } from '@util/script';\n\n$(() => {\n  checkMinimumVersion('3.4.17', '深度条目排斥器');\n  loadReadme('https://testingcf.jsdelivr.net/gh/StageDog/tavern_resource/src/酒馆助手/深度条目排斥器/README.md');\n  const { destroy } = initSquash(\n    Settings.decode({\n      name: '深度排斥器',\n      put_system_injection_after_chat_history: true,\n      on_chat_history: {\n        type: 'mixin',\n      },\n    }),\n  );\n  $(window).on('pagehide', () => {\n    destroy();\n  });\n});\n","import iframe_srcdoc from './iframe_srcdoc.html';\n\nexport async function loadReadme(url: string): Promise<boolean> {\n  const readme = await fetch(url);\n  if (!readme.ok) {\n    return false;\n  }\n  const readme_text = await readme.text();\n  replaceScriptInfo(readme_text);\n  return true;\n}\n\nexport function teleportStyle(\n  append_to: JQuery.Selector | JQuery.htmlString | JQuery.TypeOrArray<Element | DocumentFragment> | JQuery = 'head',\n): { destroy: () => void } {\n  const $div = $(`<div>`)\n    .attr('script_id', getScriptId())\n    .append($(`head > style`, document).clone())\n    .appendTo(append_to);\n\n  return {\n    destroy: () => $div.remove(),\n  };\n}\n\nexport function createScriptIdIframe(): JQuery<HTMLIFrameElement> {\n  return $(`<iframe>`).attr({\n    script_id: getScriptId(),\n    frameborder: 0,\n    srcdoc: iframe_srcdoc,\n  }) as JQuery<HTMLIFrameElement>;\n}\n\nexport function createScriptIdDiv(): JQuery<HTMLDivElement> {\n  return $('<div>').attr('script_id', getScriptId()) as JQuery<HTMLDivElement>;\n}\n\nexport function reloadOnChatChange(): EventOnReturn {\n  let chat_id = SillyTavern.getCurrentChatId();\n  return eventOn(tavern_events.CHAT_CHANGED, new_chat_id => {\n    if (chat_id !== new_chat_id) {\n      chat_id = new_chat_id;\n      window.location.reload();\n    }\n  });\n}\n"],"names":["Vue","z","Settings","object","name","string","default","seperator","type","enum","value","prefault","transform","data","depth_threshold","number","int","min","move_system_to_front","boolean","move_system_to_back","convert_system_to_user","above_placeholder","below_placeholder","put_system_injection_after_chat_history","optional","on_chat_history","squash_role","user_prefix","user_suffix","assistant_prefix","assistant_suffix","system_prefix","system_suffix","stop_string","catch","settings","ref","parse","getVariables","script_id","getScriptId","watchEffect","insertOrAssignVariables","regexFromString","input","match","RegExp","_","escapeRegExp","test","flags","pull","indexOf","uuidv4","replace","c","r","Math","random","toString","trimEmptyLines","str","lines","split","start","end","length","trim","slice","join","squashMessageByRole","prompts","array","predicate","chunks","lhs","rhs","zip","dropRight","drop","push","chunkBy","role","map","chunk","content","listenEvent","seperators","handlePrompts","prompt","dry_run","some","head_index","findIndex","includes","head","deep_index","deep","tail_index","tail","stripSeperatorIds","replaceAll","id","split_with_context","splitted_before","before_index","current_index","splitter","splitted","splitted_head","splitted_deep","splitted_tail","seperatePrompts","allPrompts","flat","isSystemWithoutPlaceholder","p","extractSystemContent","filter","aboveContent","belowContent","remove","concat","forEach","firstNonSystemIndex","i","convertSystemToUserAfterFirstNonSystem","before_chat_history","after_chat_history","rejectEmptyPrompts","result","substitudeMacros","trimmed","squashChatHistory","destination","new_array","handlePrompts2","messages","getTavernVersion","eventMakeFirst","tavern_events","GENERATE_AFTER_DATA","CHAT_COMPLETION_SETTINGS_READY","handleStopStringOnStream","text","regex","SillyTavern","stopGeneration","STREAM_TOKEN_RECEIVED","handleStopStringOnReceived","async","message_id","chat_message","chat","Number","mes","index","swipes","set","swipe_id","updateMessageBlock","saveChat","MESSAGE_RECEIVED","unlisten","eventRemoveListener","initSquash","uninject","Object","freeze","position","depth","inject","_type","_option","injectPrompts","values","eventOn","GENERATION_AFTER_COMMANDS","uninjectPrompts","injectSeperators","destroy","$","expected","title","getTavernHelperVersion","toastr","error","checkMinimumVersion","url","readme","fetch","ok","readme_text","replaceScriptInfo","loadReadme","decode","window","on"],"ignoreList":[],"sourceRoot":""}