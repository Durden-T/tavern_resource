import{compare as e}from'https://testingcf.jsdelivr.net/npm/compare-versions/+esm';import'https://testingcf.jsdelivr.net/npm/zod/v4/core/+esm';import{createPinia as t,defineStore as n,storeToRefs as l}from'https://testingcf.jsdelivr.net/npm/pinia/+esm';import{klona as o}from'https://testingcf.jsdelivr.net/npm/klona/+esm';function s(e){if(!e)return null;try{const t=e.match(/\/(.+)\/([a-z]*)/i);if(!t)return new RegExp(_.escapeRegExp(e),'i');if(t[2]&&!/^(?!.*?(.).*?\1)[gmixXsuUAJ]+$/.test(t[3]))return new RegExp(e,'i');let n=t[2]??'';return _.pull(n,'g'),-1===n.indexOf('i')&&(n+='i'),new RegExp(t[1],n)}catch{return null}}function r(){return'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,function(e){const t=16*Math.random()|0;return('x'===e?t:3&t|8).toString(16)})}const a=Vue,i=z,c=i.z.object({name:i.z.string().default('压缩相邻消息'),seperator:i.z.object({type:i.z.enum(['space','newline','double newline','custom']).default('double newline'),value:i.z.string().default('\n\n')}).prefault({}).transform(e=>{switch(e.type){case'space':e.value=' ';break;case'newline':e.value='\n';break;case'double newline':e.value='\n\n'}return e}),depth_threshold:i.z.number().int().min(1).default(10),move_system_to_front:i.z.boolean().default(!1),move_system_to_back:i.z.boolean().default(!1),convert_system_to_user:i.z.boolean().default(!1),above_placeholder:i.z.string().default(''),below_placeholder:i.z.string().default(''),put_system_injection_after_chat_history:i.z.boolean().optional(),on_chat_history:i.z.object({type:i.z.enum(['mixin','seperate','squash']).default('squash'),squash_role:i.z.enum(['user','assistant','system']).default('assistant'),user_prefix:i.z.string().default('[{{user}}]\n'),user_suffix:i.z.string().default('\n[/{{user}}]'),assistant_prefix:i.z.string().default('[剧情]\n'),assistant_suffix:i.z.string().default('\n[/剧情]'),system_prefix:i.z.string().default('[设定]\n'),system_suffix:i.z.string().default('\n[/设定]')}).prefault({}),stop_string:i.z.string().default('<|im_end|>').catch('<|im_end|>')}).transform(e=>(!0===e.put_system_injection_after_chat_history&&(e.move_system_to_front=!0,e.move_system_to_back=!0),delete e.put_system_injection_after_chat_history,e)),u=n('settings',()=>{const e=(0,a.ref)(c.parse(getVariables({type:'script',script_id:getScriptId()})));return(0,a.watchEffect)(()=>{insertOrAssignVariables(o(e.value),{type:'script',script_id:getScriptId()})}),{settings:e}});const d={class:'inline-drawer'},p={class:'inline-drawer-content'},m={class:'flex-container flexFlowColumn'},f={key:0,class:'flex-container flexFlowColumn'},v={class:'flex-container flexFlowColumn'},h={class:'flex-container flexFlowColumn'},x={style:{display:'flex','align-items':'center',gap:'8px'}},E={class:'flex-container flexFlowColumn'},y={style:{display:'flex','align-items':'center',gap:'8px'}},V={key:1,class:'flex-container flexFlowColumn'},N={class:'flex-container flexFlowColumn'},w={style:{display:'flex','align-items':'center',gap:'8px'}},g={key:2,class:'flex-container flexFlowColumn'},b={class:'flex-container flexFlowColumn'},T={key:3,class:'flex-container flexFlowColumn'},D={key:4},k={class:'flex-container flexFlowColumn',title:'用户消息前缀'},C={class:'flex-container flexFlowColumn',title:'用户消息后缀'},M={class:'flex-container flexFlowColumn',title:'助手消息前缀'},R={class:'flex-container flexFlowColumn',title:'助手消息后缀'},A={class:'flex-container flexFlowColumn',title:'系统消息前缀'},S={class:'flex-container flexFlowColumn',title:'系统消息后缀'},F={class:'flex-container flexFlowColumn'},O=(0,a.defineComponent)({__name:'Panel',setup(e){const{settings:t}=l(u());function n(e){return(0,a.computed)({get:()=>e.value.replace(/\n/g,'\\n'),set:t=>e.value=t.replace(/\\n/g,'\n')})}const o=n((0,a.toRef)(t.value.on_chat_history,'user_prefix')),s=n((0,a.toRef)(t.value.on_chat_history,'user_suffix')),r=n((0,a.toRef)(t.value.on_chat_history,'assistant_prefix')),i=n((0,a.toRef)(t.value.on_chat_history,'assistant_suffix')),c=n((0,a.toRef)(t.value.on_chat_history,'system_prefix')),O=n((0,a.toRef)(t.value.on_chat_history,'system_suffix'));function U(){SillyTavern.callGenericPopup('<h2>深度调整说明</h2> <p>按照<a href="https://discord.com/channels/1134557553011998840/1413538722078785576">一些预设作者和角色卡作者的说法</a>, Gemini 和 Claude 不同, 不必将条目插入聊天记录中, 插入其中反而会干扰聊天记录的连续性, 重要条目应该都插入到 D0.</p> <p>但玩家依旧可能使用 Claude、GPT 等游玩, 而对它们还是需要用 D4 等深度的.</p> <p>因此本脚本提供了以下选项：</p> <h3>深度阈值</h3> <p>设置分割深度的阈值，默认为 10。</p> <h3>将系统深度条目移到 D9999</h3> <p>勾选后，深度阈值及以上的系统深度条目将被移动到 D9999 位置（聊天记录之前）。</p> <h3>将系统深度条目移到 D0</h3> <p>勾选后，深度阈值以下的系统深度条目将被移动到 D0 位置（聊天记录之后）。</p> <hr> <p><strong>注意</strong>: 这些选项虽然已经不用角色卡作者自行将条目全设置为 D0，但仍很需要角色卡适配；如果角色详情等会随剧情发展的设定放在了深度条目，则勾选这些选项容易使角色固化。</p> ',SillyTavern.POPUP_TYPE.TEXT,'',{leftAlign:!0})}function j(){SillyTavern.callGenericPopup('<h2>占位符替换说明</h2> <p>设置占位符后，系统条目内容将被替换到占位符位置，而非移动到 D9999/D0。</p> <h3>上方占位符</h3> <p>设置后，D阈值及以上的系统条目内容将替换提示词中所有该占位符。</p> <p>例如：设置为 <code>{{ABOVE_DX}}</code>，则所有 <code>{{ABOVE_DX}}</code> 将被替换为对应系统条目内容。</p> <h3>下方占位符</h3> <p>设置后，D阈值以下的系统条目内容将替换提示词中所有该占位符。</p> <p>例如：设置为 <code>{{BELOW_DX}}</code>，则所有 <code>{{BELOW_DX}}</code> 将被替换为对应系统条目内容。</p> <hr> <p><strong>注意</strong>：</p> <ul> <li>留空则移动到D9999/D0</li> <li>包含占位符的消息本身不会被提取（避免循环引用）</li> <li>如果没有对应的系统条目，占位符将被替换为空字符串</li> </ul> ',SillyTavern.POPUP_TYPE.TEXT,'',{leftAlign:!0})}function P(){SillyTavern.callGenericPopup('<p>如果填入停止字符串, 则 AI 输出了对应文本时将会结束输出</p>\n     <p>停止字符串可以是字符串或正则, 如 <code>User:</code> 或 <code>/User:|System:/</code></p>',SillyTavern.POPUP_TYPE.TEXT,'',{leftAlign:!0})}return(e,n)=>((0,a.openBlock)(),(0,a.createElementBlock)('div',d,[n[40]||(n[40]=(0,a.createElementVNode)('div',{class:'inline-drawer-toggle inline-drawer-header'},[(0,a.createElementVNode)('b',null,'压缩相邻消息'),(0,a.createElementVNode)('div',{class:'inline-drawer-icon fa-solid fa-circle-chevron-down down'})],-1)),(0,a.createElementVNode)('div',p,[(0,a.createElementVNode)('div',m,[n[18]||(n[18]=(0,a.createElementVNode)('label',null,'消息分隔符',-1)),(0,a.withDirectives)((0,a.createElementVNode)('select',{'onUpdate:modelValue':n[0]||(n[0]=e=>(0,a.unref)(t).seperator.type=e),class:'text_pole'},[...n[17]||(n[17]=[(0,a.createElementVNode)('option',{value:'space'},'空格',-1),(0,a.createElementVNode)('option',{value:'newline'},'换行',-1),(0,a.createElementVNode)('option',{value:'double newline'},'双换行',-1),(0,a.createElementVNode)('option',{value:'custom'},'自定义',-1)])],512),[[a.vModelSelect,(0,a.unref)(t).seperator.type]])]),'custom'===(0,a.unref)(t).seperator.type?((0,a.openBlock)(),(0,a.createElementBlock)('div',f,[n[19]||(n[19]=(0,a.createElementVNode)('label',null,'自定义分隔符',-1)),(0,a.withDirectives)((0,a.createElementVNode)('input',{'onUpdate:modelValue':n[1]||(n[1]=e=>(0,a.unref)(t).seperator.value=e),class:'text_pole flex1 wide100p',type:'text',autocomplete:'off'},null,512),[[a.vModelText,(0,a.unref)(t).seperator.value]])])):(0,a.createCommentVNode)('v-if',!0),n[37]||(n[37]=(0,a.createElementVNode)('hr',null,null,-1)),(0,a.createElementVNode)('div',v,[n[20]||(n[20]=(0,a.createElementVNode)('label',null,'深度阈值',-1)),(0,a.withDirectives)((0,a.createElementVNode)('input',{'onUpdate:modelValue':n[2]||(n[2]=e=>(0,a.unref)(t).depth_threshold=e),type:'number',min:'1',class:'text_pole',style:{width:'80px'}},null,512),[[a.vModelText,(0,a.unref)(t).depth_threshold,void 0,{number:!0}]])]),(0,a.createElementVNode)('div',h,[(0,a.createElementVNode)('div',x,[n[21]||(n[21]=(0,a.createElementVNode)('span',null,'首个 user/assistant 之后的 system role 转为 user',-1)),(0,a.withDirectives)((0,a.createElementVNode)('input',{'onUpdate:modelValue':n[3]||(n[3]=e=>(0,a.unref)(t).convert_system_to_user=e),type:'checkbox',style:{margin:'0 4px 0 0'}},null,512),[[a.vModelCheckbox,(0,a.unref)(t).convert_system_to_user]])])]),(0,a.createElementVNode)('div',E,[(0,a.createElementVNode)('div',y,[n[22]||(n[22]=(0,a.createElementVNode)('span',null,'将 D阈值 及以上的系统深度条目移到 D9999',-1)),(0,a.withDirectives)((0,a.createElementVNode)('input',{'onUpdate:modelValue':n[4]||(n[4]=e=>(0,a.unref)(t).move_system_to_front=e),type:'checkbox',style:{margin:'0 4px 0 0'}},null,512),[[a.vModelCheckbox,(0,a.unref)(t).move_system_to_front]])])]),(0,a.unref)(t).move_system_to_front?((0,a.openBlock)(),(0,a.createElementBlock)('div',V,[(0,a.createElementVNode)('label',null,[n[23]||(n[23]=(0,a.createElementVNode)('span',null,'上方占位符',-1)),(0,a.createElementVNode)('i',{class:'fa-solid fa-circle-question fa-sm note-link-span',style:{cursor:'pointer'},onClick:j})]),(0,a.withDirectives)((0,a.createElementVNode)('input',{'onUpdate:modelValue':n[5]||(n[5]=e=>(0,a.unref)(t).above_placeholder=e),class:'text_pole flex1 wide100p',type:'text',placeholder:'如 {{ABOVE_DX}}',autocomplete:'off'},null,512),[[a.vModelText,(0,a.unref)(t).above_placeholder]])])):(0,a.createCommentVNode)('v-if',!0),(0,a.createElementVNode)('div',N,[(0,a.createElementVNode)('div',w,[n[24]||(n[24]=(0,a.createElementVNode)('span',null,'将 D阈值 以下的系统深度条目移到 D0',-1)),(0,a.withDirectives)((0,a.createElementVNode)('input',{'onUpdate:modelValue':n[6]||(n[6]=e=>(0,a.unref)(t).move_system_to_back=e),type:'checkbox',style:{margin:'0 4px 0 0'}},null,512),[[a.vModelCheckbox,(0,a.unref)(t).move_system_to_back]]),(0,a.createElementVNode)('i',{class:'fa-solid fa-circle-question fa-sm note-link-span',style:{cursor:'pointer'},onClick:U})])]),(0,a.unref)(t).move_system_to_back?((0,a.openBlock)(),(0,a.createElementBlock)('div',g,[(0,a.createElementVNode)('label',null,[n[25]||(n[25]=(0,a.createElementVNode)('span',null,'下方占位符',-1)),(0,a.createElementVNode)('i',{class:'fa-solid fa-circle-question fa-sm note-link-span',style:{cursor:'pointer'},onClick:j})]),(0,a.withDirectives)((0,a.createElementVNode)('input',{'onUpdate:modelValue':n[7]||(n[7]=e=>(0,a.unref)(t).below_placeholder=e),class:'text_pole flex1 wide100p',type:'text',placeholder:'如 {{BELOW_DX}}',autocomplete:'off'},null,512),[[a.vModelText,(0,a.unref)(t).below_placeholder]])])):(0,a.createCommentVNode)('v-if',!0),n[38]||(n[38]=(0,a.createElementVNode)('hr',null,null,-1)),(0,a.createElementVNode)('div',b,[n[27]||(n[27]=(0,a.createElementVNode)('label',null,'聊天历史处理方式',-1)),(0,a.withDirectives)((0,a.createElementVNode)('select',{'onUpdate:modelValue':n[8]||(n[8]=e=>(0,a.unref)(t).on_chat_history.type=e),class:'text_pole'},[...n[26]||(n[26]=[(0,a.createElementVNode)('option',{value:'mixin'},'与其他提示词混合',-1),(0,a.createElementVNode)('option',{value:'seperate'},'与其他提示词隔离',-1),(0,a.createElementVNode)('option',{value:'squash'},'单独压缩为一条消息',-1)])],512),[[a.vModelSelect,(0,a.unref)(t).on_chat_history.type]])]),'squash'===(0,a.unref)(t).on_chat_history.type?((0,a.openBlock)(),(0,a.createElementBlock)('div',T,[n[29]||(n[29]=(0,a.createElementVNode)('label',null,'压缩角色',-1)),(0,a.withDirectives)((0,a.createElementVNode)('select',{'onUpdate:modelValue':n[9]||(n[9]=e=>(0,a.unref)(t).on_chat_history.squash_role=e),class:'text_pole'},[...n[28]||(n[28]=[(0,a.createElementVNode)('option',{value:'system'},'系统',-1),(0,a.createElementVNode)('option',{value:'user'},'用户',-1),(0,a.createElementVNode)('option',{value:'assistant'},'助手',-1)])],512),[[a.vModelSelect,(0,a.unref)(t).on_chat_history.squash_role]])])):(0,a.createCommentVNode)('v-if',!0),'squash'===(0,a.unref)(t).on_chat_history.type?((0,a.openBlock)(),(0,a.createElementBlock)('div',D,[(0,a.createElementVNode)('div',k,[n[30]||(n[30]=(0,a.createElementVNode)('label',null,'用户前缀',-1)),(0,a.withDirectives)((0,a.createElementVNode)('input',{'onUpdate:modelValue':n[10]||(n[10]=e=>(0,a.isRef)(o)?o.value=e:null),class:'text_pole flex1 wide100p',type:'text',autocomplete:'off'},null,512),[[a.vModelText,(0,a.unref)(o)]])]),(0,a.createElementVNode)('div',C,[n[31]||(n[31]=(0,a.createElementVNode)('label',null,'用户后缀',-1)),(0,a.withDirectives)((0,a.createElementVNode)('input',{'onUpdate:modelValue':n[11]||(n[11]=e=>(0,a.isRef)(s)?s.value=e:null),class:'text_pole flex1 wide100p',type:'text',autocomplete:'off'},null,512),[[a.vModelText,(0,a.unref)(s)]])]),(0,a.createElementVNode)('div',M,[n[32]||(n[32]=(0,a.createElementVNode)('label',null,'助手前缀',-1)),(0,a.withDirectives)((0,a.createElementVNode)('input',{'onUpdate:modelValue':n[12]||(n[12]=e=>(0,a.isRef)(r)?r.value=e:null),class:'text_pole flex1 wide100p',type:'text',autocomplete:'off'},null,512),[[a.vModelText,(0,a.unref)(r)]])]),(0,a.createElementVNode)('div',R,[n[33]||(n[33]=(0,a.createElementVNode)('label',null,'助手后缀',-1)),(0,a.withDirectives)((0,a.createElementVNode)('input',{'onUpdate:modelValue':n[13]||(n[13]=e=>(0,a.isRef)(i)?i.value=e:null),class:'text_pole flex1 wide100p',type:'text',autocomplete:'off'},null,512),[[a.vModelText,(0,a.unref)(i)]])]),(0,a.createElementVNode)('div',A,[n[34]||(n[34]=(0,a.createElementVNode)('label',null,'系统前缀',-1)),(0,a.withDirectives)((0,a.createElementVNode)('input',{'onUpdate:modelValue':n[14]||(n[14]=e=>(0,a.isRef)(c)?c.value=e:null),class:'text_pole flex1 wide100p',type:'text',autocomplete:'off'},null,512),[[a.vModelText,(0,a.unref)(c)]])]),(0,a.createElementVNode)('div',S,[n[35]||(n[35]=(0,a.createElementVNode)('label',null,'系统后缀',-1)),(0,a.withDirectives)((0,a.createElementVNode)('input',{'onUpdate:modelValue':n[15]||(n[15]=e=>(0,a.isRef)(O)?O.value=e:null),class:'text_pole flex1 wide100p',type:'text',autocomplete:'off'},null,512),[[a.vModelText,(0,a.unref)(O)]])])])):(0,a.createCommentVNode)('v-if',!0),n[39]||(n[39]=(0,a.createElementVNode)('hr',null,null,-1)),(0,a.createElementVNode)('div',F,[(0,a.createElementVNode)('label',null,[n[36]||(n[36]=(0,a.createElementVNode)('span',null,'停止字符串',-1)),(0,a.createElementVNode)('i',{class:'fa-solid fa-circle-question fa-sm note-link-span',style:{cursor:'pointer'},title:'当模型输出了对应字符串时将会停止',onClick:P})]),(0,a.withDirectives)((0,a.createElementVNode)('input',{'onUpdate:modelValue':n[16]||(n[16]=e=>(0,a.unref)(t).stop_string=e),class:'text_pole flex1 wide100p',type:'text',placeholder:'请输入字符串或 /正则/',autocomplete:'off'},null,512),[[a.vModelText,(0,a.unref)(t).stop_string]])])])]))}});function U(){const e=(0,a.createApp)(O).use(t()),n=$('<div>').attr('script_id',getScriptId()).appendTo('#extensions_settings2');e.mount(n[0]);const{destroy:l}=function(e='head'){const t=$('<div>').attr('script_id',getScriptId()).append($('head > style',document).clone()).appendTo(e);return{destroy:()=>t.remove()}}();return{destroy:()=>{e.unmount(),n.remove(),l()}}}function j(e){const t=e.split('\n');let n=0,l=t.length;for(;n<l&&!t[n].trim();)n++;for(;l>n&&!t[l-1].trim();)l--;return t.slice(n,l).join('\n')}function P(e,t){return function(e,t){if(0===e.length)return[];const n=[[e[0]]];for(const[l,o]of _.zip(_.dropRight(e),_.drop(e)))t(l,o)?n[n.length-1].push(o):n.push([o]);return n}(e,(e,t)=>e.role===t.role).map(e=>({role:e[0].role,content:e.map(({content:e})=>j(e)).join(t.seperator.value)}))}function I(t,n){const l=({prompt:e},l)=>{if(l)return;if(e.some(({content:e})=>'string'!=typeof e))return;t.convert_system_to_user&&function(e){const t=e.findIndex(e=>'user'===e.role||'assistant'===e.role);if(-1!==t)for(let n=t+1;n<e.length;n++)'system'===e[n].role&&(e[n].role='user')}(e);const o=function(e,t){const n=e.findIndex(({content:e})=>e.includes(t.head.content)),l=e.findIndex(({content:e})=>e.includes(t.deep.content)),o=e.findIndex(({content:e})=>e.includes(t.tail.content));if(-1===n||-1===l||-1===o)return null;if(!(n<l&&l<o))return null;const s=(t,n,l,o)=>{if(n!==l)return e[l].content.split(o);const s=t[1].split(o);return t[1]='',s},r=s(['',''],-1,n,t.head.content),a=s(r,n,l,t.deep.content),i=s(a,l,o,t.tail.content);return[[...e.slice(0,n),{role:e[n].role,content:r[0]}],[{role:e[n].role,content:r[1]},...e.slice(n+1,l),{role:e[l].role,content:a[0]}],[{role:e[l].role,content:a[1]},...e.slice(l+1,o),{role:e[o].role,content:i[0]}],[{role:e[o].role,content:i[1]},...e.slice(o+1)]]}(e,n);if(null===o)return;const{above_placeholder:s,below_placeholder:r,move_system_to_front:a,move_system_to_back:i,seperator:c}=t,u=o.flat(),d=e=>!('system'!==e.role||s&&e.content.includes(s)||r&&e.content.includes(r)),p=e=>e.filter(d).filter(e=>e.content.trim()).map(e=>j(e.content)).join(c.value),m=a?p(o[1]):'',f=i?p(o[2]):'';a&&(s&&u.some(e=>e.content.includes(s))?_.remove(o[1],d):o[0]=_.concat(o[0],_.remove(o[1],e=>'system'===e.role))),i&&(r&&u.some(e=>e.content.includes(r))?_.remove(o[2],d):o[3]=_.concat(_.remove(o[2],e=>'system'===e.role),o[3]));const[v,h,x,E]=_(o).map(e=>function(e){return e.filter(({content:e})=>''!==e.trim())}(e)).map(e=>P(e,t)).value();let y;switch(t.on_chat_history.type){case'mixin':y=P(_.concat(v,h,x,E),t);break;case'seperate':y=_.concat(v,P(_.concat(h,x),t),E);break;case'squash':y=_.concat(v,function(e,t){const n=substitudeMacros(t.on_chat_history.system_prefix),l=substitudeMacros(t.on_chat_history.system_suffix),o=substitudeMacros(t.on_chat_history.assistant_prefix),s=substitudeMacros(t.on_chat_history.assistant_suffix),r=substitudeMacros(t.on_chat_history.user_prefix),a=substitudeMacros(t.on_chat_history.user_suffix);return{role:t.on_chat_history.squash_role,content:e.map(({role:e,content:t})=>{const i=j(t);switch(e){case'system':return n+i+l;case'assistant':return o+i+s;case'user':return r+i+a}}).join(t.seperator.value)}}(_.concat(h,x),t),E)}for(const e of y)s&&(e.content=e.content.replaceAll(s,m)),r&&(e.content=e.content.replaceAll(r,f));var V,N;N=y,(V=e).length=0,V.push(...N)},o=({messages:e})=>{l({prompt:e},!1)};e(getTavernVersion(),'1.13.4','>')?eventMakeFirst(tavern_events.GENERATE_AFTER_DATA,l):eventMakeFirst(tavern_events.CHAT_COMPLETION_SETTINGS_READY,o);const r=e=>{if(!t.stop_string)return;const n=s(t.stop_string);n&&n.test(e)&&SillyTavern.stopGeneration()};eventMakeFirst(tavern_events.STREAM_TOKEN_RECEIVED,r);const a=async e=>{if(!t.stop_string)return;const n=SillyTavern.chat[Number(e)],l=s(t.stop_string);if(!l)return;const o=n.mes.match(l);o&&(n.mes=n.mes.slice(0,o.index),n.swipes&&_.set(n,['swipes',n.swipe_id],n.mes),SillyTavern.updateMessageBlock(Number(e),n),await SillyTavern.saveChat())};return eventMakeFirst(tavern_events.MESSAGE_RECEIVED,a),{unlisten:()=>{eventRemoveListener(tavern_events.GENERATE_AFTER_DATA,l),eventRemoveListener(tavern_events.CHAT_COMPLETION_SETTINGS_READY,o),eventRemoveListener(tavern_events.STREAM_TOKEN_RECEIVED,r),eventRemoveListener(tavern_events.MESSAGE_RECEIVED,a)}}}function B(e){const{seperators:t,uninject:n}=function(e){const t=Object.freeze({head:{id:`\0${e.name}`,position:'in_chat',depth:9999,role:'assistant',content:r()},deep:{id:`ÿ${e.name}深度分割`,position:'in_chat',depth:e.depth_threshold-1,role:'system',content:r()},tail:{id:`ÿ${e.name}ÿ`,position:'in_chat',depth:0,role:'system',content:r()}}),n=(e,n,l)=>{l||injectPrompts(Object.values(t))};return eventOn(tavern_events.GENERATION_AFTER_COMMANDS,n),{seperators:t,uninject:()=>{eventRemoveListener(tavern_events.GENERATION_AFTER_COMMANDS,n),uninjectPrompts(Object.values(t).map(({id:e})=>e))}}}(e),{unlisten:l}=I(e,t);return{destroy:()=>{n(),l()}}}$(()=>{!async function(t,n){e(await getTavernHelperVersion(),t,'<')&&toastr.error(`'${n}' 需要酒馆助手版本 >= '${t}'`,'版本不兼容')}('3.4.17','压缩相邻消息'),async function(e){const t=await fetch(e);if(!t.ok)return!1;const n=await t.text();replaceScriptInfo(n)}('https://testingcf.jsdelivr.net/gh/StageDog/tavern_resource/src/酒馆助手/压缩相邻消息/README.md');const{destroy:t}=U(),{destroy:n}=B(u().settings);$(window).on('pagehide',()=>{t(),n()})});
//# sourceMappingURL=index.js.map