{"version":3,"file":"index.js","mappings":"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","sources":["src://tavern_helper_template/util/common.ts","src://tavern_helper_template/external var \"Vue\"","src://tavern_helper_template/external var \"z\"","src://tavern_helper_template/src/酒馆助手/压缩相邻消息/settings.ts","webpack://tavern_helper_template/src/酒馆助手/压缩相邻消息/placeholder-help.md?b587","src://tavern_helper_template/src/酒馆助手/压缩相邻消息/Panel.vue","webpack://tavern_helper_template/src/酒馆助手/压缩相邻消息/Panel.vue?10dd","webpack://tavern_helper_template/src/酒馆助手/压缩相邻消息/depth-help.md?60e3","src://tavern_helper_template/src/酒馆助手/压缩相邻消息/panel.ts","src://tavern_helper_template/util/script.ts","src://tavern_helper_template/src/酒馆助手/压缩相邻消息/squash.ts","src://tavern_helper_template/src/酒馆助手/压缩相邻消息/index.ts"],"sourcesContent":["import { compare } from 'compare-versions';\nimport { toDotPath } from 'zod/v4/core';\n\nexport function assignInplace<T>(destination: T[], new_array: T[]): T[] {\n  destination.length = 0;\n  destination.push(...new_array);\n  return destination;\n}\n\nexport function chunkBy<T>(array: T[], predicate: (lhs: T, rhs: T) => boolean): T[][] {\n  if (array.length === 0) {\n    return [];\n  }\n\n  const chunks: T[][] = [[array[0]]];\n  for (const [lhs, rhs] of _.zip(_.dropRight(array), _.drop(array))) {\n    if (predicate(lhs!, rhs!)) {\n      chunks[chunks.length - 1].push(rhs!);\n    } else {\n      chunks.push([rhs!]);\n    }\n  }\n  return chunks;\n}\n\nexport function regexFromString(input: string): RegExp | null {\n  if (!input) {\n    return null;\n  }\n  try {\n    const match = input.match(/\\/(.+)\\/([a-z]*)/i);\n    if (!match) {\n      return new RegExp(_.escapeRegExp(input), 'i');\n    }\n    if (match[2] && !/^(?!.*?(.).*?\\1)[gmixXsuUAJ]+$/.test(match[3])) {\n      return new RegExp(input, 'i');\n    }\n    let flags = match[2] ?? '';\n    _.pull(flags, 'g');\n    if (flags.indexOf('i') === -1) {\n      flags = flags + 'i';\n    }\n    return new RegExp(match[1], flags);\n  } catch {\n    return null;\n  }\n}\n\nexport function uuidv4(): string {\n  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {\n    const r = (Math.random() * 16) | 0;\n    const v = c === 'x' ? r : (r & 0x3) | 0x8;\n    return v.toString(16);\n  });\n}\n\nexport async function checkMinimumVersion(expected: string, title: string) {\n  if (compare(await getTavernHelperVersion(), expected, '<')) {\n    toastr.error(`'${title}' 需要酒馆助手版本 >= '${expected}'`, '版本不兼容');\n  }\n}\n\nexport function prettifyErrorWithInput(error: z.ZodError) {\n  return _([...error.issues])\n    .sortBy(issue => issue.path?.length ?? 0)\n    .flatMap(issue => {\n      const lines = [`✖ ${issue.message}`];\n      if (issue.path?.length) {\n        lines.push(`  → 路径: ${toDotPath(issue.path)}`);\n      }\n      if (issue.input !== undefined) {\n        lines.push(`  → 输入: ${JSON.stringify(issue.input)}`);\n      }\n      return lines;\n    })\n    .join('\\n');\n}\n","const __WEBPACK_NAMESPACE_OBJECT__ = Vue;","const __WEBPACK_NAMESPACE_OBJECT__ = z;","import { defineStore } from 'pinia';\nimport { ref, watchEffect } from 'vue';\nexport const Settings = z\n    .object({\n    name: z.string().default('压缩相邻消息'),\n    seperator: z\n        .object({\n        type: z.enum(['space', 'newline', 'double newline', 'custom']).default('double newline'),\n        value: z.string().default('\\n\\n'),\n    })\n        .prefault({})\n        .transform(data => {\n        switch (data.type) {\n            case 'space':\n                data.value = ' ';\n                break;\n            case 'newline':\n                data.value = '\\n';\n                break;\n            case 'double newline':\n                data.value = '\\n\\n';\n                break;\n            case 'custom':\n                break;\n        }\n        return data;\n    }),\n    depth_threshold: z.number().int().min(1).default(10),\n    move_system_to_front: z.boolean().default(false),\n    move_system_to_back: z.boolean().default(false),\n    convert_system_to_user: z.boolean().default(false),\n    above_placeholder: z.string().default(''),\n    below_placeholder: z.string().default(''),\n    put_system_injection_after_chat_history: z.boolean().optional(),\n    on_chat_history: z\n        .object({\n        type: z.enum(['mixin', 'seperate', 'squash']).default('squash'),\n        squash_role: z.enum(['user', 'assistant', 'system']).default('assistant'),\n        user_prefix: z.string().default('[{{user}}]\\n'),\n        user_suffix: z.string().default('\\n[/{{user}}]'),\n        assistant_prefix: z.string().default('[剧情]\\n'),\n        assistant_suffix: z.string().default('\\n[/剧情]'),\n        system_prefix: z.string().default('[设定]\\n'),\n        system_suffix: z.string().default('\\n[/设定]'),\n    })\n        .prefault({}),\n    stop_string: z.string().default('<|im_end|>').catch('<|im_end|>'),\n})\n    .transform(data => {\n    if (data.put_system_injection_after_chat_history === true) {\n        data.move_system_to_front = true;\n        data.move_system_to_back = true;\n    }\n    delete data.put_system_injection_after_chat_history;\n    return data;\n});\nexport const useSettingsStore = defineStore('settings', () => {\n    const settings = ref(Settings.parse(getVariables({ type: 'script', script_id: getScriptId() })));\n    watchEffect(() => {\n        insertOrAssignVariables(klona(settings.value), { type: 'script', script_id: getScriptId() });\n    });\n    return { settings };\n});\n","// Module\nvar code = `<h2>占位符替换说明</h2> <p>设置占位符后，系统条目内容将被替换到占位符位置，而非移动到 D9999/D0。</p> <h3>上方占位符</h3> <p>设置后，D阈值及以上的系统条目内容将替换提示词中所有该占位符。</p> <p>例如：设置为 <code>{{ABOVE_DX}}</code>，则所有 <code>{{ABOVE_DX}}</code> 将被替换为对应系统条目内容。</p> <h3>下方占位符</h3> <p>设置后，D阈值以下的系统条目内容将替换提示词中所有该占位符。</p> <p>例如：设置为 <code>{{BELOW_DX}}</code>，则所有 <code>{{BELOW_DX}}</code> 将被替换为对应系统条目内容。</p> <hr> <p><strong>注意</strong>：</p> <ul> <li>留空则移动到D9999/D0</li> <li>包含占位符的消息本身不会被提取（避免循环引用）</li> <li>如果没有对应的系统条目，占位符将被替换为空字符串</li> </ul> `;\n// Exports\nexport default code;","import { defineComponent as _defineComponent } from 'vue';\nimport { createElementVNode as _createElementVNode, unref as _unref, vModelSelect as _vModelSelect, withDirectives as _withDirectives, vModelText as _vModelText, openBlock as _openBlock, createElementBlock as _createElementBlock, createCommentVNode as _createCommentVNode, vModelCheckbox as _vModelCheckbox, isRef as _isRef } from \"vue\";\nconst _hoisted_1 = { class: \"inline-drawer\" };\nconst _hoisted_2 = { class: \"inline-drawer-content\" };\nconst _hoisted_3 = { class: \"flex-container flexFlowColumn\" };\nconst _hoisted_4 = {\n    key: 0,\n    class: \"flex-container flexFlowColumn\"\n};\nconst _hoisted_5 = { class: \"flex-container flexFlowColumn\" };\nconst _hoisted_6 = { class: \"flex-container flexFlowColumn\" };\nconst _hoisted_7 = { style: { \"display\": \"flex\", \"align-items\": \"center\", \"gap\": \"8px\" } };\nconst _hoisted_8 = { class: \"flex-container flexFlowColumn\" };\nconst _hoisted_9 = { style: { \"display\": \"flex\", \"align-items\": \"center\", \"gap\": \"8px\" } };\nconst _hoisted_10 = {\n    key: 1,\n    class: \"flex-container flexFlowColumn\"\n};\nconst _hoisted_11 = { class: \"flex-container flexFlowColumn\" };\nconst _hoisted_12 = { style: { \"display\": \"flex\", \"align-items\": \"center\", \"gap\": \"8px\" } };\nconst _hoisted_13 = {\n    key: 2,\n    class: \"flex-container flexFlowColumn\"\n};\nconst _hoisted_14 = { class: \"flex-container flexFlowColumn\" };\nconst _hoisted_15 = {\n    key: 3,\n    class: \"flex-container flexFlowColumn\"\n};\nconst _hoisted_16 = { key: 4 };\nconst _hoisted_17 = {\n    class: \"flex-container flexFlowColumn\",\n    title: \"用户消息前缀\"\n};\nconst _hoisted_18 = {\n    class: \"flex-container flexFlowColumn\",\n    title: \"用户消息后缀\"\n};\nconst _hoisted_19 = {\n    class: \"flex-container flexFlowColumn\",\n    title: \"助手消息前缀\"\n};\nconst _hoisted_20 = {\n    class: \"flex-container flexFlowColumn\",\n    title: \"助手消息后缀\"\n};\nconst _hoisted_21 = {\n    class: \"flex-container flexFlowColumn\",\n    title: \"系统消息前缀\"\n};\nconst _hoisted_22 = {\n    class: \"flex-container flexFlowColumn\",\n    title: \"系统消息后缀\"\n};\nconst _hoisted_23 = { class: \"flex-container flexFlowColumn\" };\nimport { storeToRefs } from 'pinia';\nimport { computed } from 'vue';\nimport { useSettingsStore } from './settings';\nimport depthHelpHtml from './depth-help.md';\nimport placeholderHelpHtml from './placeholder-help.md';\n\nimport { ref, toRef } from 'vue';\nexport default /*@__PURE__*/ _defineComponent({\n    __name: 'Panel',\n    setup(__props) {\n        const { settings } = storeToRefs(useSettingsStore());\n        function useEscapedNewlineModel(ref) {\n            return computed({\n                get: () => ref.value.replace(/\\n/g, '\\\\n'),\n                set: value => (ref.value = value.replace(/\\\\n/g, '\\n')),\n            });\n        }\n        const user_prefix_input = useEscapedNewlineModel(toRef(settings.value.on_chat_history, 'user_prefix'));\n        const user_suffix_input = useEscapedNewlineModel(toRef(settings.value.on_chat_history, 'user_suffix'));\n        const assistant_prefix_input = useEscapedNewlineModel(toRef(settings.value.on_chat_history, 'assistant_prefix'));\n        const assistant_suffix_input = useEscapedNewlineModel(toRef(settings.value.on_chat_history, 'assistant_suffix'));\n        const system_prefix_input = useEscapedNewlineModel(toRef(settings.value.on_chat_history, 'system_prefix'));\n        const system_suffix_input = useEscapedNewlineModel(toRef(settings.value.on_chat_history, 'system_suffix'));\n        function showDepthHelp() {\n            SillyTavern.callGenericPopup(depthHelpHtml, SillyTavern.POPUP_TYPE.TEXT, '', { leftAlign: true });\n        }\n        function showPlaceholderHelp() {\n            SillyTavern.callGenericPopup(placeholderHelpHtml, SillyTavern.POPUP_TYPE.TEXT, '', { leftAlign: true });\n        }\n        function showStopStringHelp() {\n            SillyTavern.callGenericPopup(`<p>如果填入停止字符串, 则 AI 输出了对应文本时将会结束输出</p>\n     <p>停止字符串可以是字符串或正则, 如 <code>User:</code> 或 <code>/User:|System:/</code></p>`, SillyTavern.POPUP_TYPE.TEXT, '', { leftAlign: true });\n        }\n        return (_ctx, _cache) => {\n            return (_openBlock(), _createElementBlock(\"div\", _hoisted_1, [\n                _cache[40] || (_cache[40] = _createElementVNode(\"div\", { class: \"inline-drawer-toggle inline-drawer-header\" }, [\n                    _createElementVNode(\"b\", null, \"压缩相邻消息\"),\n                    _createElementVNode(\"div\", { class: \"inline-drawer-icon fa-solid fa-circle-chevron-down down\" })\n                ], -1 /* CACHED */)),\n                _createElementVNode(\"div\", _hoisted_2, [\n                    _createElementVNode(\"div\", _hoisted_3, [\n                        _cache[18] || (_cache[18] = _createElementVNode(\"label\", null, \"消息分隔符\", -1 /* CACHED */)),\n                        _withDirectives(_createElementVNode(\"select\", {\n                            \"onUpdate:modelValue\": _cache[0] || (_cache[0] = ($event) => ((_unref(settings).seperator.type) = $event)),\n                            class: \"text_pole\"\n                        }, [...(_cache[17] || (_cache[17] = [\n                                _createElementVNode(\"option\", { value: \"space\" }, \"空格\", -1 /* CACHED */),\n                                _createElementVNode(\"option\", { value: \"newline\" }, \"换行\", -1 /* CACHED */),\n                                _createElementVNode(\"option\", { value: \"double newline\" }, \"双换行\", -1 /* CACHED */),\n                                _createElementVNode(\"option\", { value: \"custom\" }, \"自定义\", -1 /* CACHED */)\n                            ]))], 512 /* NEED_PATCH */), [\n                            [_vModelSelect, _unref(settings).seperator.type]\n                        ])\n                    ]),\n                    (_unref(settings).seperator.type === 'custom')\n                        ? (_openBlock(), _createElementBlock(\"div\", _hoisted_4, [\n                            _cache[19] || (_cache[19] = _createElementVNode(\"label\", null, \"自定义分隔符\", -1 /* CACHED */)),\n                            _withDirectives(_createElementVNode(\"input\", {\n                                \"onUpdate:modelValue\": _cache[1] || (_cache[1] = ($event) => ((_unref(settings).seperator.value) = $event)),\n                                class: \"text_pole flex1 wide100p\",\n                                type: \"text\",\n                                autocomplete: \"off\"\n                            }, null, 512 /* NEED_PATCH */), [\n                                [_vModelText, _unref(settings).seperator.value]\n                            ])\n                        ]))\n                        : _createCommentVNode(\"v-if\", true),\n                    _cache[37] || (_cache[37] = _createElementVNode(\"hr\", null, null, -1 /* CACHED */)),\n                    _createElementVNode(\"div\", _hoisted_5, [\n                        _cache[20] || (_cache[20] = _createElementVNode(\"label\", null, \"深度阈值\", -1 /* CACHED */)),\n                        _withDirectives(_createElementVNode(\"input\", {\n                            \"onUpdate:modelValue\": _cache[2] || (_cache[2] = ($event) => ((_unref(settings).depth_threshold) = $event)),\n                            type: \"number\",\n                            min: \"1\",\n                            class: \"text_pole\",\n                            style: { \"width\": \"80px\" }\n                        }, null, 512 /* NEED_PATCH */), [\n                            [\n                                _vModelText,\n                                _unref(settings).depth_threshold,\n                                void 0,\n                                { number: true }\n                            ]\n                        ])\n                    ]),\n                    _createElementVNode(\"div\", _hoisted_6, [\n                        _createElementVNode(\"div\", _hoisted_7, [\n                            _cache[21] || (_cache[21] = _createElementVNode(\"span\", null, \"首个 user/assistant 之后的 system role 转为 user\", -1 /* CACHED */)),\n                            _withDirectives(_createElementVNode(\"input\", {\n                                \"onUpdate:modelValue\": _cache[3] || (_cache[3] = ($event) => ((_unref(settings).convert_system_to_user) = $event)),\n                                type: \"checkbox\",\n                                style: { \"margin\": \"0 4px 0 0\" }\n                            }, null, 512 /* NEED_PATCH */), [\n                                [_vModelCheckbox, _unref(settings).convert_system_to_user]\n                            ])\n                        ])\n                    ]),\n                    _createElementVNode(\"div\", _hoisted_8, [\n                        _createElementVNode(\"div\", _hoisted_9, [\n                            _cache[22] || (_cache[22] = _createElementVNode(\"span\", null, \"将 D阈值 及以上的系统深度条目移到 D9999\", -1 /* CACHED */)),\n                            _withDirectives(_createElementVNode(\"input\", {\n                                \"onUpdate:modelValue\": _cache[4] || (_cache[4] = ($event) => ((_unref(settings).move_system_to_front) = $event)),\n                                type: \"checkbox\",\n                                style: { \"margin\": \"0 4px 0 0\" }\n                            }, null, 512 /* NEED_PATCH */), [\n                                [_vModelCheckbox, _unref(settings).move_system_to_front]\n                            ])\n                        ])\n                    ]),\n                    (_unref(settings).move_system_to_front)\n                        ? (_openBlock(), _createElementBlock(\"div\", _hoisted_10, [\n                            _createElementVNode(\"label\", null, [\n                                _cache[23] || (_cache[23] = _createElementVNode(\"span\", null, \"上方占位符\", -1 /* CACHED */)),\n                                _createElementVNode(\"i\", {\n                                    class: \"fa-solid fa-circle-question fa-sm note-link-span\",\n                                    style: { \"cursor\": \"pointer\" },\n                                    onClick: showPlaceholderHelp\n                                })\n                            ]),\n                            _withDirectives(_createElementVNode(\"input\", {\n                                \"onUpdate:modelValue\": _cache[5] || (_cache[5] = ($event) => ((_unref(settings).above_placeholder) = $event)),\n                                class: \"text_pole flex1 wide100p\",\n                                type: \"text\",\n                                placeholder: \"如 {{ABOVE_DX}}\",\n                                autocomplete: \"off\"\n                            }, null, 512 /* NEED_PATCH */), [\n                                [_vModelText, _unref(settings).above_placeholder]\n                            ])\n                        ]))\n                        : _createCommentVNode(\"v-if\", true),\n                    _createElementVNode(\"div\", _hoisted_11, [\n                        _createElementVNode(\"div\", _hoisted_12, [\n                            _cache[24] || (_cache[24] = _createElementVNode(\"span\", null, \"将 D阈值 以下的系统深度条目移到 D0\", -1 /* CACHED */)),\n                            _withDirectives(_createElementVNode(\"input\", {\n                                \"onUpdate:modelValue\": _cache[6] || (_cache[6] = ($event) => ((_unref(settings).move_system_to_back) = $event)),\n                                type: \"checkbox\",\n                                style: { \"margin\": \"0 4px 0 0\" }\n                            }, null, 512 /* NEED_PATCH */), [\n                                [_vModelCheckbox, _unref(settings).move_system_to_back]\n                            ]),\n                            _createElementVNode(\"i\", {\n                                class: \"fa-solid fa-circle-question fa-sm note-link-span\",\n                                style: { \"cursor\": \"pointer\" },\n                                onClick: showDepthHelp\n                            })\n                        ])\n                    ]),\n                    (_unref(settings).move_system_to_back)\n                        ? (_openBlock(), _createElementBlock(\"div\", _hoisted_13, [\n                            _createElementVNode(\"label\", null, [\n                                _cache[25] || (_cache[25] = _createElementVNode(\"span\", null, \"下方占位符\", -1 /* CACHED */)),\n                                _createElementVNode(\"i\", {\n                                    class: \"fa-solid fa-circle-question fa-sm note-link-span\",\n                                    style: { \"cursor\": \"pointer\" },\n                                    onClick: showPlaceholderHelp\n                                })\n                            ]),\n                            _withDirectives(_createElementVNode(\"input\", {\n                                \"onUpdate:modelValue\": _cache[7] || (_cache[7] = ($event) => ((_unref(settings).below_placeholder) = $event)),\n                                class: \"text_pole flex1 wide100p\",\n                                type: \"text\",\n                                placeholder: \"如 {{BELOW_DX}}\",\n                                autocomplete: \"off\"\n                            }, null, 512 /* NEED_PATCH */), [\n                                [_vModelText, _unref(settings).below_placeholder]\n                            ])\n                        ]))\n                        : _createCommentVNode(\"v-if\", true),\n                    _cache[38] || (_cache[38] = _createElementVNode(\"hr\", null, null, -1 /* CACHED */)),\n                    _createElementVNode(\"div\", _hoisted_14, [\n                        _cache[27] || (_cache[27] = _createElementVNode(\"label\", null, \"聊天历史处理方式\", -1 /* CACHED */)),\n                        _withDirectives(_createElementVNode(\"select\", {\n                            \"onUpdate:modelValue\": _cache[8] || (_cache[8] = ($event) => ((_unref(settings).on_chat_history.type) = $event)),\n                            class: \"text_pole\"\n                        }, [...(_cache[26] || (_cache[26] = [\n                                _createElementVNode(\"option\", { value: \"mixin\" }, \"与其他提示词混合\", -1 /* CACHED */),\n                                _createElementVNode(\"option\", { value: \"seperate\" }, \"与其他提示词隔离\", -1 /* CACHED */),\n                                _createElementVNode(\"option\", { value: \"squash\" }, \"单独压缩为一条消息\", -1 /* CACHED */)\n                            ]))], 512 /* NEED_PATCH */), [\n                            [_vModelSelect, _unref(settings).on_chat_history.type]\n                        ])\n                    ]),\n                    (_unref(settings).on_chat_history.type === 'squash')\n                        ? (_openBlock(), _createElementBlock(\"div\", _hoisted_15, [\n                            _cache[29] || (_cache[29] = _createElementVNode(\"label\", null, \"压缩角色\", -1 /* CACHED */)),\n                            _withDirectives(_createElementVNode(\"select\", {\n                                \"onUpdate:modelValue\": _cache[9] || (_cache[9] = ($event) => ((_unref(settings).on_chat_history.squash_role) = $event)),\n                                class: \"text_pole\"\n                            }, [...(_cache[28] || (_cache[28] = [\n                                    _createElementVNode(\"option\", { value: \"system\" }, \"系统\", -1 /* CACHED */),\n                                    _createElementVNode(\"option\", { value: \"user\" }, \"用户\", -1 /* CACHED */),\n                                    _createElementVNode(\"option\", { value: \"assistant\" }, \"助手\", -1 /* CACHED */)\n                                ]))], 512 /* NEED_PATCH */), [\n                                [_vModelSelect, _unref(settings).on_chat_history.squash_role]\n                            ])\n                        ]))\n                        : _createCommentVNode(\"v-if\", true),\n                    (_unref(settings).on_chat_history.type === 'squash')\n                        ? (_openBlock(), _createElementBlock(\"div\", _hoisted_16, [\n                            _createElementVNode(\"div\", _hoisted_17, [\n                                _cache[30] || (_cache[30] = _createElementVNode(\"label\", null, \"用户前缀\", -1 /* CACHED */)),\n                                _withDirectives(_createElementVNode(\"input\", {\n                                    \"onUpdate:modelValue\": _cache[10] || (_cache[10] = ($event) => (_isRef(user_prefix_input) ? (user_prefix_input).value = $event : null)),\n                                    class: \"text_pole flex1 wide100p\",\n                                    type: \"text\",\n                                    autocomplete: \"off\"\n                                }, null, 512 /* NEED_PATCH */), [\n                                    [_vModelText, _unref(user_prefix_input)]\n                                ])\n                            ]),\n                            _createElementVNode(\"div\", _hoisted_18, [\n                                _cache[31] || (_cache[31] = _createElementVNode(\"label\", null, \"用户后缀\", -1 /* CACHED */)),\n                                _withDirectives(_createElementVNode(\"input\", {\n                                    \"onUpdate:modelValue\": _cache[11] || (_cache[11] = ($event) => (_isRef(user_suffix_input) ? (user_suffix_input).value = $event : null)),\n                                    class: \"text_pole flex1 wide100p\",\n                                    type: \"text\",\n                                    autocomplete: \"off\"\n                                }, null, 512 /* NEED_PATCH */), [\n                                    [_vModelText, _unref(user_suffix_input)]\n                                ])\n                            ]),\n                            _createElementVNode(\"div\", _hoisted_19, [\n                                _cache[32] || (_cache[32] = _createElementVNode(\"label\", null, \"助手前缀\", -1 /* CACHED */)),\n                                _withDirectives(_createElementVNode(\"input\", {\n                                    \"onUpdate:modelValue\": _cache[12] || (_cache[12] = ($event) => (_isRef(assistant_prefix_input) ? (assistant_prefix_input).value = $event : null)),\n                                    class: \"text_pole flex1 wide100p\",\n                                    type: \"text\",\n                                    autocomplete: \"off\"\n                                }, null, 512 /* NEED_PATCH */), [\n                                    [_vModelText, _unref(assistant_prefix_input)]\n                                ])\n                            ]),\n                            _createElementVNode(\"div\", _hoisted_20, [\n                                _cache[33] || (_cache[33] = _createElementVNode(\"label\", null, \"助手后缀\", -1 /* CACHED */)),\n                                _withDirectives(_createElementVNode(\"input\", {\n                                    \"onUpdate:modelValue\": _cache[13] || (_cache[13] = ($event) => (_isRef(assistant_suffix_input) ? (assistant_suffix_input).value = $event : null)),\n                                    class: \"text_pole flex1 wide100p\",\n                                    type: \"text\",\n                                    autocomplete: \"off\"\n                                }, null, 512 /* NEED_PATCH */), [\n                                    [_vModelText, _unref(assistant_suffix_input)]\n                                ])\n                            ]),\n                            _createElementVNode(\"div\", _hoisted_21, [\n                                _cache[34] || (_cache[34] = _createElementVNode(\"label\", null, \"系统前缀\", -1 /* CACHED */)),\n                                _withDirectives(_createElementVNode(\"input\", {\n                                    \"onUpdate:modelValue\": _cache[14] || (_cache[14] = ($event) => (_isRef(system_prefix_input) ? (system_prefix_input).value = $event : null)),\n                                    class: \"text_pole flex1 wide100p\",\n                                    type: \"text\",\n                                    autocomplete: \"off\"\n                                }, null, 512 /* NEED_PATCH */), [\n                                    [_vModelText, _unref(system_prefix_input)]\n                                ])\n                            ]),\n                            _createElementVNode(\"div\", _hoisted_22, [\n                                _cache[35] || (_cache[35] = _createElementVNode(\"label\", null, \"系统后缀\", -1 /* CACHED */)),\n                                _withDirectives(_createElementVNode(\"input\", {\n                                    \"onUpdate:modelValue\": _cache[15] || (_cache[15] = ($event) => (_isRef(system_suffix_input) ? (system_suffix_input).value = $event : null)),\n                                    class: \"text_pole flex1 wide100p\",\n                                    type: \"text\",\n                                    autocomplete: \"off\"\n                                }, null, 512 /* NEED_PATCH */), [\n                                    [_vModelText, _unref(system_suffix_input)]\n                                ])\n                            ])\n                        ]))\n                        : _createCommentVNode(\"v-if\", true),\n                    _cache[39] || (_cache[39] = _createElementVNode(\"hr\", null, null, -1 /* CACHED */)),\n                    _createElementVNode(\"div\", _hoisted_23, [\n                        _createElementVNode(\"label\", null, [\n                            _cache[36] || (_cache[36] = _createElementVNode(\"span\", null, \"停止字符串\", -1 /* CACHED */)),\n                            _createElementVNode(\"i\", {\n                                class: \"fa-solid fa-circle-question fa-sm note-link-span\",\n                                style: { \"cursor\": \"pointer\" },\n                                title: \"当模型输出了对应字符串时将会停止\",\n                                onClick: showStopStringHelp\n                            })\n                        ]),\n                        _withDirectives(_createElementVNode(\"input\", {\n                            \"onUpdate:modelValue\": _cache[16] || (_cache[16] = ($event) => ((_unref(settings).stop_string) = $event)),\n                            class: \"text_pole flex1 wide100p\",\n                            type: \"text\",\n                            placeholder: \"请输入字符串或 /正则/\",\n                            autocomplete: \"off\"\n                        }, null, 512 /* NEED_PATCH */), [\n                            [_vModelText, _unref(settings).stop_string]\n                        ])\n                    ])\n                ])\n            ]));\n        };\n    }\n});\n","/* unplugin-vue-components disabled */import script from \"./Panel.vue?vue&type=script&setup=true&lang=ts\"\nexport * from \"./Panel.vue?vue&type=script&setup=true&lang=ts\"\n\nconst __exports__ = script;\n\nexport default __exports__","// Module\nvar code = `<h2>深度调整说明</h2> <p>按照<a href=\"https://discord.com/channels/1134557553011998840/1413538722078785576\">一些预设作者和角色卡作者的说法</a>, Gemini 和 Claude 不同, 不必将条目插入聊天记录中, 插入其中反而会干扰聊天记录的连续性, 重要条目应该都插入到 D0.</p> <p>但玩家依旧可能使用 Claude、GPT 等游玩, 而对它们还是需要用 D4 等深度的.</p> <p>因此本脚本提供了以下选项：</p> <h3>深度阈值</h3> <p>设置分割深度的阈值，默认为 10。</p> <h3>将系统深度条目移到 D9999</h3> <p>勾选后，深度阈值及以上的系统深度条目将被移动到 D9999 位置（聊天记录之前）。</p> <h3>将系统深度条目移到 D0</h3> <p>勾选后，深度阈值以下的系统深度条目将被移动到 D0 位置（聊天记录之后）。</p> <hr> <p><strong>注意</strong>: 这些选项虽然已经不用角色卡作者自行将条目全设置为 D0，但仍很需要角色卡适配；如果角色详情等会随剧情发展的设定放在了深度条目，则勾选这些选项容易使角色固化。</p> `;\n// Exports\nexport default code;","import { createScriptIdDiv, teleportStyle } from '@util/script';\nimport { createPinia } from 'pinia';\nimport { createApp } from 'vue';\nimport Panel from './Panel.vue';\n\nexport function initPanel() {\n  const app = createApp(Panel).use(createPinia());\n\n  const $app = createScriptIdDiv().appendTo('#extensions_settings2');\n  app.mount($app[0]);\n\n  const { destroy } = teleportStyle();\n\n  return {\n    destroy: () => {\n      app.unmount();\n      $app.remove();\n      destroy();\n    },\n  };\n}\n","import iframe_srcdoc from './iframe_srcdoc.html';\n\nexport async function loadReadme(url: string): Promise<boolean> {\n  const readme = await fetch(url);\n  if (!readme.ok) {\n    return false;\n  }\n  const readme_text = await readme.text();\n  replaceScriptInfo(readme_text);\n  return true;\n}\n\nexport function teleportStyle(\n  append_to: JQuery.Selector | JQuery.htmlString | JQuery.TypeOrArray<Element | DocumentFragment> | JQuery = 'head',\n): { destroy: () => void } {\n  const $div = $(`<div>`)\n    .attr('script_id', getScriptId())\n    .append($(`head > style`, document).clone())\n    .appendTo(append_to);\n\n  return {\n    destroy: () => $div.remove(),\n  };\n}\n\nexport function createScriptIdIframe(): JQuery<HTMLIFrameElement> {\n  return $(`<iframe>`).attr({\n    script_id: getScriptId(),\n    frameborder: 0,\n    srcdoc: iframe_srcdoc,\n  }) as JQuery<HTMLIFrameElement>;\n}\n\nexport function createScriptIdDiv(): JQuery<HTMLDivElement> {\n  return $('<div>').attr('script_id', getScriptId()) as JQuery<HTMLDivElement>;\n}\n\nexport function reloadOnChatChange(): EventOnReturn {\n  let chat_id = SillyTavern.getCurrentChatId();\n  return eventOn(tavern_events.CHAT_CHANGED, new_chat_id => {\n    if (chat_id !== new_chat_id) {\n      chat_id = new_chat_id;\n      window.location.reload();\n    }\n  });\n}\n","import { assignInplace, chunkBy, regexFromString, uuidv4 } from '@util/common';\nimport { compare } from 'compare-versions';\nimport { Settings } from './settings';\n\ntype Prompt = {\n  role: 'user' | 'assistant' | 'system';\n  content: string;\n};\n\n//----------------------------------------------------------------------------------------------------------------------\ntype Seperators = {\n  head: InjectionPrompt;\n  deep: InjectionPrompt;\n  tail: InjectionPrompt;\n};\n\nfunction injectSeperators(settings: Settings) {\n  const seperators = Object.freeze({\n    head: {\n      id: `\\0${settings.name}`,\n      position: 'in_chat',\n      depth: 9999,\n      role: 'assistant',\n      content: uuidv4(),\n    },\n    deep: {\n      id: `\\xff${settings.name}深度分割`,\n      position: 'in_chat',\n      // 减1以兼容之前的行为：分隔符位于D阈值下方，确保同深度的系统条目排在分隔符之前\n      depth: settings.depth_threshold - 1,\n      role: 'system',\n      content: uuidv4(),\n    },\n    tail: {\n      id: `\\xff${settings.name}`,\n      position: 'in_chat',\n      depth: 0,\n      role: 'system',\n      content: uuidv4(),\n    },\n  } as const);\n\n  const inject = (_type: string, _option: object, dry_run: boolean) => {\n    if (dry_run) {\n      return;\n    }\n    injectPrompts(Object.values(seperators));\n  };\n  eventOn(tavern_events.GENERATION_AFTER_COMMANDS, inject);\n\n  return {\n    seperators,\n    uninject: () => {\n      eventRemoveListener(tavern_events.GENERATION_AFTER_COMMANDS, inject);\n      uninjectPrompts(Object.values(seperators).map(({ id }) => id));\n    },\n  };\n}\n\n//----------------------------------------------------------------------------------------------------------------------\nfunction seperatePrompts(prompts: Prompt[], seperators: Seperators): Prompt[][] | null {\n  const head_index = prompts.findIndex(({ content }) => content.includes(seperators.head.content));\n  const deep_index = prompts.findIndex(({ content }) => content.includes(seperators.deep.content));\n  const tail_index = prompts.findIndex(({ content }) => content.includes(seperators.tail.content));\n  if (head_index === -1 || deep_index === -1 || tail_index === -1) {\n    return null;\n  }\n\n  const split_with_context = (\n    splitted_before: [string, string],\n    before_index: number,\n    current_index: number,\n    splitter: string,\n  ): [string, string] => {\n    if (before_index !== current_index) {\n      return prompts[current_index].content.split(splitter) as [string, string];\n    }\n    const splitted = splitted_before[1].split(splitter) as [string, string];\n    splitted_before[1] = '';\n    return splitted;\n  };\n\n  const splitted_head = split_with_context(['', ''], -1, head_index, seperators.head.content);\n  const splitted_deep = split_with_context(splitted_head, head_index, deep_index, seperators.deep.content);\n  const splitted_tail = split_with_context(splitted_deep, deep_index, tail_index, seperators.tail.content);\n\n  return [\n    [...prompts.slice(0, head_index), { role: prompts[head_index].role, content: splitted_head[0] }],\n    [\n      { role: prompts[head_index].role, content: splitted_head[1] },\n      ...prompts.slice(head_index + 1, deep_index),\n      { role: prompts[deep_index].role, content: splitted_deep[0] },\n    ],\n    [\n      { role: prompts[deep_index].role, content: splitted_deep[1] },\n      ...prompts.slice(deep_index + 1, tail_index),\n      { role: prompts[tail_index].role, content: splitted_tail[0] },\n    ],\n    [{ role: prompts[tail_index].role, content: splitted_tail[1] }, ...prompts.slice(tail_index + 1)],\n  ];\n}\n\nfunction convertSystemToUserAfterFirstNonSystem(prompts: Prompt[]): void {\n  const firstNonSystemIndex = prompts.findIndex(p => p.role === 'user' || p.role === 'assistant');\n  if (firstNonSystemIndex === -1) {\n    return;\n  }\n  for (let i = firstNonSystemIndex + 1; i < prompts.length; i++) {\n    if (prompts[i].role === 'system') {\n      prompts[i].role = 'user';\n    }\n  }\n}\n\nfunction trimEmptyLines(str: string): string {\n  const lines = str.split('\\n');\n  let start = 0;\n  let end = lines.length;\n  while (start < end && !lines[start].trim()) start++;\n  while (end > start && !lines[end - 1].trim()) end--;\n  return lines.slice(start, end).join('\\n');\n}\n\nfunction rejectEmptyPrompts(prompts: Prompt[]): Prompt[] {\n  return prompts.filter(({ content }) => content.trim() !== '');\n}\n\nfunction squashMessageByRole(prompts: Prompt[], settings: Settings): Prompt[] {\n  return chunkBy(prompts, (lhs, rhs) => lhs.role === rhs.role).map(chunk => ({\n    role: chunk[0].role,\n    content: chunk.map(({ content }) => trimEmptyLines(content)).join(settings.seperator.value),\n  }));\n}\n\nfunction squashChatHistory(prompts: Prompt[], settings: Settings): Prompt {\n  // TODO: zod encode\n  const system_prefix = substitudeMacros(settings.on_chat_history.system_prefix);\n  const system_suffix = substitudeMacros(settings.on_chat_history.system_suffix);\n  const assistant_prefix = substitudeMacros(settings.on_chat_history.assistant_prefix);\n  const assistant_suffix = substitudeMacros(settings.on_chat_history.assistant_suffix);\n  const user_prefix = substitudeMacros(settings.on_chat_history.user_prefix);\n  const user_suffix = substitudeMacros(settings.on_chat_history.user_suffix);\n  return {\n    role: settings.on_chat_history.squash_role,\n    content: prompts\n      .map(({ role, content }) => {\n        const trimmed = trimEmptyLines(content);\n        switch (role) {\n          case 'system':\n            return system_prefix + trimmed + system_suffix;\n          case 'assistant':\n            return assistant_prefix + trimmed + assistant_suffix;\n          case 'user':\n            return user_prefix + trimmed + user_suffix;\n        }\n      })\n      .join(settings.seperator.value),\n  };\n}\n\nfunction listenEvent(settings: Settings, seperators: Seperators) {\n  const handlePrompts = ({ prompt }: { prompt: SillyTavern.SendingMessage[] }, dry_run: boolean) => {\n    if (dry_run) {\n      return;\n    }\n\n    if (prompt.some(({ content }) => typeof content !== 'string')) {\n      // TODO: 支持带图片、多媒体的脚本\n      return;\n    }\n\n    if (settings.convert_system_to_user) {\n      // @ts-expect-error 类型正确\n      convertSystemToUserAfterFirstNonSystem(prompt);\n    }\n\n    // @ts-expect-error 类型正确\n    const chunks = seperatePrompts(prompt, seperators);\n    if (chunks === null) {\n      return;\n    }\n\n    const { above_placeholder, below_placeholder, move_system_to_front, move_system_to_back, seperator } = settings;\n    const allPrompts = chunks.flat();\n\n    // 含占位符的系统消息需保留原位，占位符会被替换为提取的内容\n    const isSystemWithoutPlaceholder = (p: Prompt): boolean =>\n      p.role === 'system' &&\n      !(above_placeholder && p.content.includes(above_placeholder)) &&\n      !(below_placeholder && p.content.includes(below_placeholder));\n\n    const extractSystemContent = (chunk: Prompt[]): string =>\n      chunk.filter(isSystemWithoutPlaceholder).filter(p => p.content.trim()).map(p => trimEmptyLines(p.content)).join(seperator.value);\n\n    // 先提取内容，再移除/移动消息\n    const aboveContent = move_system_to_front ? extractSystemContent(chunks[1]) : '';\n    const belowContent = move_system_to_back ? extractSystemContent(chunks[2]) : '';\n\n    if (move_system_to_front) {\n      if (above_placeholder && allPrompts.some(p => p.content.includes(above_placeholder))) {\n        // 有占位符：仅移除，内容通过占位符替换注入\n        _.remove(chunks[1], isSystemWithoutPlaceholder);\n      } else {\n        // 无占位符：直接移动到 head 末尾\n        chunks[0] = _.concat(chunks[0], _.remove(chunks[1], p => p.role === 'system'));\n      }\n    }\n\n    if (move_system_to_back) {\n      if (below_placeholder && allPrompts.some(p => p.content.includes(below_placeholder))) {\n        _.remove(chunks[2], isSystemWithoutPlaceholder);\n      } else {\n        // 无占位符：直接移动到 tail 开头\n        chunks[3] = _.concat(_.remove(chunks[2], p => p.role === 'system'), chunks[3]);\n      }\n    }\n\n    const [head, before_chat_history, after_chat_history, tail] = _(chunks)\n      .map(prompts => rejectEmptyPrompts(prompts))\n      .map(prompts => squashMessageByRole(prompts, settings))\n      .value();\n\n    let result: Prompt[];\n    switch (settings.on_chat_history.type) {\n      case 'mixin':\n        result = squashMessageByRole(_.concat(head, before_chat_history, after_chat_history, tail), settings);\n        break;\n      case 'seperate':\n        result = _.concat(head, squashMessageByRole(_.concat(before_chat_history, after_chat_history), settings), tail);\n        break;\n      case 'squash':\n        result = _.concat(head, squashChatHistory(_.concat(before_chat_history, after_chat_history), settings), tail);\n        break;\n    }\n\n    for (const p of result) {\n      if (above_placeholder) p.content = p.content.replaceAll(above_placeholder, aboveContent);\n      if (below_placeholder) p.content = p.content.replaceAll(below_placeholder, belowContent);\n    }\n\n    assignInplace(prompt, result);\n  };\n  const handlePrompts2 = ({ messages }: { messages: SillyTavern.SendingMessage[] }) => {\n    handlePrompts({ prompt: messages }, false);\n  };\n\n  if (compare(getTavernVersion(), '1.13.4', '>')) {\n    eventMakeFirst(tavern_events.GENERATE_AFTER_DATA, handlePrompts);\n  } else {\n    eventMakeFirst(tavern_events.CHAT_COMPLETION_SETTINGS_READY, handlePrompts2);\n  }\n\n  const handleStopStringOnStream = (text: string) => {\n    if (!settings.stop_string) {\n      return;\n    }\n    const regex = regexFromString(settings.stop_string);\n    if (!regex) {\n      return;\n    }\n    if (regex.test(text)) {\n      SillyTavern.stopGeneration();\n    }\n  };\n  eventMakeFirst(tavern_events.STREAM_TOKEN_RECEIVED, handleStopStringOnStream);\n\n  const handleStopStringOnReceived = async (message_id: number | string) => {\n    if (!settings.stop_string) {\n      return;\n    }\n\n    const chat_message = SillyTavern.chat[Number(message_id)];\n\n    const regex = regexFromString(settings.stop_string);\n    if (!regex) {\n      return;\n    }\n    const match = chat_message.mes.match(regex);\n    if (match) {\n      chat_message.mes = chat_message.mes.slice(0, match.index);\n      if (chat_message.swipes) {\n        _.set(chat_message, ['swipes', chat_message.swipe_id!], chat_message.mes);\n      }\n      // 与 https://gitgud.io/Monblant/noass 采用相同逻辑而不使用 setChatMessages, 因为 CHARACTER_MESSAGE_RENDERED 将会随后自然触发\n      SillyTavern.updateMessageBlock(Number(message_id), chat_message);\n      await SillyTavern.saveChat();\n    }\n  };\n  eventMakeFirst(tavern_events.MESSAGE_RECEIVED, handleStopStringOnReceived);\n\n  return {\n    unlisten: () => {\n      eventRemoveListener(tavern_events.GENERATE_AFTER_DATA, handlePrompts);\n      eventRemoveListener(tavern_events.CHAT_COMPLETION_SETTINGS_READY, handlePrompts2);\n      eventRemoveListener(tavern_events.STREAM_TOKEN_RECEIVED, handleStopStringOnStream);\n      eventRemoveListener(tavern_events.MESSAGE_RECEIVED, handleStopStringOnReceived);\n    },\n  };\n}\n\n//----------------------------------------------------------------------------------------------------------------------\nexport function initSquash(settings: Settings) {\n  const { seperators, uninject } = injectSeperators(settings);\n  const { unlisten } = listenEvent(settings, seperators);\n  return {\n    destroy: () => {\n      uninject();\n      unlisten();\n    },\n  };\n}\n","import { checkMinimumVersion } from '@util/common';\nimport { loadReadme } from '@util/script';\nimport { initPanel } from './panel';\nimport { useSettingsStore } from './settings';\nimport { initSquash } from './squash';\n\n$(() => {\n  checkMinimumVersion('3.4.17', '压缩相邻消息');\n  loadReadme('https://testingcf.jsdelivr.net/gh/StageDog/tavern_resource/src/酒馆助手/压缩相邻消息/README.md');\n\n  const { destroy: destroyPanel } = initPanel();\n  const { destroy: destroySquash } = initSquash(useSettingsStore().settings);\n\n  $(window).on('pagehide', () => {\n    destroyPanel();\n    destroySquash();\n  });\n});\n"],"names":["regexFromString","input","match","RegExp","_","escapeRegExp","test","flags","pull","indexOf","uuidv4","replace","c","r","Math","random","toString","Vue","z","Settings","object","name","string","default","seperator","type","enum","value","prefault","transform","data","depth_threshold","number","int","min","move_system_to_front","boolean","move_system_to_back","convert_system_to_user","above_placeholder","below_placeholder","put_system_injection_after_chat_history","optional","on_chat_history","squash_role","user_prefix","user_suffix","assistant_prefix","assistant_suffix","system_prefix","system_suffix","stop_string","catch","useSettingsStore","settings","ref","parse","getVariables","script_id","getScriptId","watchEffect","insertOrAssignVariables","_hoisted_1","class","_hoisted_2","_hoisted_3","_hoisted_4","key","_hoisted_5","_hoisted_6","_hoisted_7","style","_hoisted_8","_hoisted_9","_hoisted_10","_hoisted_11","_hoisted_12","_hoisted_13","_hoisted_14","_hoisted_15","_hoisted_16","_hoisted_17","title","_hoisted_18","_hoisted_19","_hoisted_20","_hoisted_21","_hoisted_22","_hoisted_23","__name","setup","__props","useEscapedNewlineModel","computed","get","set","user_prefix_input","toRef","user_suffix_input","assistant_prefix_input","assistant_suffix_input","system_prefix_input","system_suffix_input","showDepthHelp","SillyTavern","callGenericPopup","POPUP_TYPE","TEXT","leftAlign","showPlaceholderHelp","showStopStringHelp","_ctx","_cache","$event","autocomplete","onClick","placeholder","initPanel","app","createApp","Panel","use","$app","$","attr","appendTo","mount","destroy","append_to","$div","append","document","clone","remove","teleportStyle","unmount","trimEmptyLines","str","lines","split","start","end","length","trim","slice","join","squashMessageByRole","prompts","array","predicate","chunks","lhs","rhs","zip","dropRight","drop","push","chunkBy","role","map","chunk","content","listenEvent","seperators","handlePrompts","prompt","dry_run","some","firstNonSystemIndex","findIndex","p","i","convertSystemToUserAfterFirstNonSystem","head_index","includes","head","deep_index","deep","tail_index","tail","split_with_context","splitted_before","before_index","current_index","splitter","splitted","splitted_head","splitted_deep","splitted_tail","seperatePrompts","allPrompts","flat","isSystemWithoutPlaceholder","extractSystemContent","filter","aboveContent","belowContent","concat","before_chat_history","after_chat_history","rejectEmptyPrompts","result","substitudeMacros","trimmed","squashChatHistory","replaceAll","destination","new_array","handlePrompts2","messages","getTavernVersion","eventMakeFirst","tavern_events","GENERATE_AFTER_DATA","CHAT_COMPLETION_SETTINGS_READY","handleStopStringOnStream","text","regex","stopGeneration","STREAM_TOKEN_RECEIVED","handleStopStringOnReceived","async","message_id","chat_message","chat","Number","mes","index","swipes","swipe_id","updateMessageBlock","saveChat","MESSAGE_RECEIVED","unlisten","eventRemoveListener","initSquash","uninject","Object","freeze","id","position","depth","inject","_type","_option","injectPrompts","values","eventOn","GENERATION_AFTER_COMMANDS","uninjectPrompts","injectSeperators","expected","getTavernHelperVersion","toastr","error","checkMinimumVersion","url","readme","fetch","ok","readme_text","replaceScriptInfo","loadReadme","destroyPanel","destroySquash","window","on"],"ignoreList":[],"sourceRoot":""}